# 前端 GraphQL → gRPC 迁移开发计划

> **项目目标**：将 Vue3 前端从 GraphQL 架构迁移到 gRPC + REST 双协议架构
> 
> **技术栈**：Vue 3 + TypeScript + Vite + Naive UI + Pinia + gRPC-Web
> 
> **开发周期**：预计 3-4 周
> 
> **负责模块**：前端应用层（apps/naive-admin）

---

## 📋 迁移概览

| 当前技术栈 | 目标技术栈 | 改动类型 |
|------------|------------|----------|
| Apollo Client + GraphQL | gRPC-Web + Axios | 🔄 重大重构 |
| GraphQL Queries/Mutations | Protobuf Messages | 🔄 重大重构 |
| useQuery, useMutation | API Client + Pinia | 🔄 重大重构 |
| 手动类型定义 | Protobuf 自动生成 | 🔄 重大重构 |

---

## 🎯 阶段一：构建工具和环境配置（第1周）

### 步骤 1.1：配置 Vite 支持 Protobuf
**目标**：增强 Vite 构建配置以支持 Protobuf 编译

**具体任务**：
- [ ] 安装 Protobuf 相关依赖
  - `vite-plugin-proto`
  - `@improbable-eng/grpc-web`
  - `@improbable-eng/grpc-web-webtext-transport`
  - `google-protobuf`
  - `ts-proto`
- [ ] 配置 Vite 插件
  - 添加 `protoPlugin` 到 `vite.config.ts`
  - 配置 proto 文件输入路径
  - 设置 TypeScript 输出目录 `src/shared`
- [ ] 配置环境变量支持
  - 添加 `VITE_GRPC_ENDPOINT` 配置
  - 添加 `VITE_PREFER_GRPC` 协议选择配置

**产出物**：
- 更新的 `vite.config.ts` 文件
- 新的环境变量配置文件

**验收标准**：
- Vite 构建无错误
- Protobuf 编译正常
- 环境变量正确加载

---

### 步骤 1.2：清理 GraphQL 相关依赖
**目标**：移除所有 GraphQL 相关的包和配置

**具体任务**：
- [ ] 卸载 GraphQL 相关依赖
  - `@apollo/client`
  - `graphql`
  - `@vue/apollo-composable`
- [ ] 删除 GraphQL 配置文件
  - Apollo Client 配置文件
  - GraphQL 查询文件
- [ ] 清理导入引用
  - 搜索并删除所有 GraphQL 相关导入
  - 删除未使用的类型定义
- [ ] 更新 `package.json`

**产出物**：
- 清理后的依赖列表
- 删除的 GraphQL 配置文件

**验收标准**：
- 项目构建无 GraphQL 相关错误
- 依赖包大小减少
- 代码中无遗留 GraphQL 引用

---

### 步骤 1.3：建立 Protobuf 类型生成流程
**目标**：建立自动化的 Protobuf 类型生成和更新机制

**具体任务**：
- [ ] 配置编译脚本
  - 添加 `proto:gen` 脚本到 `package.json`
  - 添加 `proto:watch` 监听脚本
  - 配置 `dev:with-proto` 开发脚本
- [ ] 创建 `src/shared/` 目录结构
  - 为生成的类型文件准备目录
  - 添加 `.gitignore` 规则
- [ ] 测试类型生成
  - 验证 proto 文件编译
  - 检查生成的 TypeScript 类型
  - 测试类型导入功能

**产出物**：
- 自动化编译脚本
- `src/shared/` 类型目录
- 生成的 TypeScript 类型文件

**验收标准**：
- 编译脚本正常执行
- 生成的类型文件语法正确
- IDE 类型提示正常工作

---

### 步骤 1.4：配置开发环境变量
**目标**：建立支持双协议开发的环境配置

**具体任务**：
- [ ] 创建环境变量文件
  - `.env.development` - 开发环境配置
  - `.env.production` - 生产环境配置
  - `.env.local` - 本地个人配置模板
- [ ] 配置 gRPC 相关变量
  - `VITE_GRPC_ENDPOINT` - gRPC 服务地址
  - `VITE_API_URL` - REST API 地址
  - `VITE_PREFER_GRPC` - 协议偏好设置
- [ ] 配置调试相关变量
  - `VITE_PROTO_DEBUG` - Protobuf 调试模式
  - `VITE_DEV_TOOLS` - 开发工具启用
- [ ] 更新 TypeScript 配置

**产出物**：
- 完整的环境变量配置
- 更新的 TypeScript 配置

**验收标准**：
- 环境变量正确加载
- 不同环境配置隔离
- 开发体验优化

---

## 🔧 阶段二：API 层重构（第2周）

### 步骤 2.1：创建 gRPC-Web 客户端
**目标**：建立基础的 gRPC-Web 通信能力

**具体任务**：
- [ ] 创建 `src/request/grpc-client.ts`
  - 配置 gRPC-Web 传输
  - 创建服务客户端实例
  - 实现统一错误处理
- [ ] 创建服务客户端工厂
  - `UserServiceClient` 实例
  - `RbacServiceClient` 实例
  - 统一的客户端配置
- [ ] 实现 gRPC 调用封装
  - 通用的 `grpcCall` 方法
  - 错误处理和重试机制
  - 请求超时配置
- [ ] 添加连接测试功能

**产出物**：
- gRPC-Web 客户端基础库
- 服务客户端实例
- 连接测试脚本

**验收标准**：
- gRPC 连接成功
- 基础调用功能正常
- 错误处理机制有效

---

### 步骤 2.2：增强 Axios 客户端
**目标**：升级 Axios 客户端以支持 Protobuf 数据处理

**具体任务**：
- [ ] 更新 `src/request/axios.ts`
  - 添加 Protobuf 序列化支持
  - 配置请求/响应转换器
  - 保持现有 HTTP 功能
- [ ] 实现数据转换器
  - Protobuf Message 序列化
  - 响应数据反序列化
  - JSON 兼容性处理
- [ ] 优化错误处理
  - 统一错误响应格式
  - HTTP 状态码映射
  - 网络错误处理
- [ ] 保持向后兼容性

**产出物**：
- 增强的 Axios 配置
- Protobuf 数据转换器
- 向后兼容的 API

**验收标准**：
- 支持 Protobuf 数据传输
- 现有 HTTP 接口正常
- 错误处理统一

---

### 步骤 2.3：实现混合 API 客户端
**目标**：创建智能选择协议的统一 API 客户端

**具体任务**：
- [ ] 创建 `src/request/hybrid-client.ts`
  - 实现 `HybridApiClient` 类
  - 智能协议选择逻辑
  - 自动降级机制
- [ ] 实现协议切换策略
  - 基于环境变量的协议选择
  - 运行时协议切换
  - 降级策略配置
- [ ] 统一接口封装
  - 统一的方法签名
  - 一致的返回格式
  - 透明的协议切换
- [ ] 添加缓存机制
  - 响应数据缓存
  - 缓存失效策略
  - 缓存性能优化

**产出物**：
- 混合 API 客户端
- 协议切换策略
- 缓存机制实现

**验收标准**：
- 协议选择逻辑正确
- 降级机制工作正常
- 接口调用体验一致

---

### 步骤 2.4：重构业务 API 模块
**目标**：将现有的 GraphQL API 调用转换为 Protobuf API

**具体任务**：
- [ ] 重构用户认证 API (`src/request/api/users.ts`)
  - 替换 GraphQL mutations 为 gRPC 调用
  - 使用 Protobuf 类型定义
  - 保持相同的接口契约
- [ ] 重构权限管理 API (`src/request/api/rbac.ts`)
  - 迁移权限查询接口
  - 迁移角色管理接口
  - 统一返回数据格式
- [ ] 保留通用工具 API (`src/request/api/common.ts`)
  - 保持工具类接口不变
  - 添加 Protobuf 支持
- [ ] 更新类型导入
  - 从 `@/shared/` 导入 Protobuf 类型
  - 删除手动类型定义

**产出物**：
- 重构的用户 API 模块
- 重构的权限 API 模块
- 保持的通用 API 模块

**验收标准**：
- API 接口功能保持一致
- 使用 Protobuf 类型定义
- 调用方式向后兼容

---

## 🏗️ 阶段三：状态管理迁移（第3周前半周）

### 步骤 3.1：重构用户状态管理
**目标**：将用户状态管理从 GraphQL 迁移到 Protobuf API

**具体任务**：
- [ ] 更新 `src/store/modules/user.ts`
  - 移除 Apollo Client 依赖
  - 导入新的 API 客户端
  - 使用 Protobuf 类型定义
- [ ] 重构用户认证逻辑
  - 更新登录方法实现
  - 更新用户信息获取
  - 保持状态结构不变
- [ ] 实现数据缓存策略
  - 用户信息本地缓存
  - 缓存更新策略
  - 离线数据支持
- [ ] 更新错误处理
  - 统一错误状态管理
  - 用户友好的错误提示

**产出物**：
- 重构的用户状态管理
- 新的数据缓存策略
- 改进的错误处理

**验收标准**：
- 用户认证流程正常
- 状态管理功能完整
- 错误处理用户友好

---

### 步骤 3.2：重构权限状态管理
**目标**：迁移权限相关的状态管理逻辑

**具体任务**：
- [ ] 更新 `src/store/modules/permission.ts`
  - 移除 Vue Apollo 依赖
  - 使用新的权限 API 客户端
  - 实现主动数据获取
- [ ] 重构权限数据管理
  - 权限列表获取和缓存
  - 角色信息管理
  - 权限状态计算
- [ ] 实现响应式权限更新
  - 权限变更实时同步
  - 状态自动更新
  - 组件权限重新计算
- [ ] 优化权限检查性能
  - 权限计算缓存
  - 批量权限检查
  - 懒加载权限数据

**产出物**：
- 重构的权限状态管理
- 响应式权限更新机制
- 性能优化的权限检查

**验收标准**：
- 权限管理功能完整
- 权限状态同步正确
- 权限检查性能良好

---

### 步骤 3.3：优化全局状态管理
**目标**：优化和统一全局状态管理策略

**具体任务**：
- [ ] 审查现有 Store 模块
  - 检查 `src/store/modules/global.ts`
  - 优化 `src/store/modules/menu.ts`
  - 更新 `src/store/modules/tab.ts`
- [ ] 实现统一的数据获取策略
  - 统一的 API 调用方式
  - 一致的错误处理
  - 统一的加载状态管理
- [ ] 添加数据同步机制
  - 跨模块数据同步
  - 实时数据更新
  - 冲突解决策略
- [ ] 性能优化
  - 状态订阅优化
  - 不必要的计算减少
  - 内存使用优化

**产出物**：
- 优化的全局状态管理
- 统一的数据获取策略
- 改进的性能表现

**验收标准**：
- 状态管理统一高效
- 数据同步机制健全
- 性能表现良好

---

## 🎨 阶段四：组件层适配（第3周后半周）

### 步骤 4.1：重构核心业务组件
**目标**：适配核心业务组件以使用新的 API 和状态管理

**具体任务**：
- [ ] 重构用户管理相关组件
  - 更新登录组件（如果存在）
  - 适配用户信息显示组件
  - 更新用户操作组件
- [ ] 重构权限管理组件
  - 更新 `src/views/operation-manage/column.vue`
  - 适配权限配置组件
  - 更新角色管理组件
- [ ] 保持组件接口不变
  - 组件 props 保持兼容
  - 事件回调保持一致
  - 外部调用方式不变
- [ ] 优化组件性能
  - 减少不必要的重渲染
  - 优化数据获取时机
  - 添加适当的缓存

**产出物**：
- 重构的核心业务组件
- 保持的组件接口兼容性
- 优化的组件性能

**验收标准**：
- 组件功能正常
- 接口保持向后兼容
- 性能有所提升

---

### 步骤 4.2：增强动态表单组件
**目标**：增强 dForm 组件以支持 Protobuf 配置

**具体任务**：
- [ ] 扩展 `src/components/dForm/types.ts`
  - 兼容 Protobuf 类型定义
  - 扩展 Vue 特定属性
  - 保持向后兼容性
- [ ] 增强表单根组件 `src/components/dForm/root.vue`
  - 支持 Protobuf 验证规则
  - 改进表单提交处理
  - 添加 gRPC 提交支持
- [ ] 优化表单验证
  - 基于 Protobuf 的验证规则生成
  - 实时验证和错误提示
  - 自定义验证规则支持
- [ ] 添加表单构建器功能
  - 可视化表单设计
  - 拖拽式字段配置
  - 动态表单预览

**产出物**：
- 增强的动态表单组件
- Protobuf 集成的验证系统
- 可视化表单构建器

**验收标准**：
- 表单功能完整强大
- Protobuf 集成无缝
- 构建器易用性好

---

### 步骤 4.3：优化数据列表组件
**目标**：基于 Protobuf 定义优化数据展示组件

**具体任务**：
- [ ] 重构 `src/views/listDemo.vue`
  - 使用 Protobuf 定义的表格配置
  - 支持复杂数据展示和操作
  - 添加高级筛选功能
- [ ] 创建增强数据表格组件
  - 基于 Naive UI DataTable
  - 支持配置化列定义
  - 内置操作按钮和批量操作
- [ ] 优化数据加载和分页
  - 虚拟滚动支持
  - 智能分页策略
  - 数据预加载
- [ ] 添加导出和导入功能
  - 支持多种格式导出
  - 批量数据操作
  - 数据校验和处理

**产出物**：
- 重构的数据列表组件
- 增强的数据表格组件
- 完整的数据操作功能

**验收标准**：
- 数据展示功能强大
- 用户操作体验流畅
- 性能表现优秀

---

### 步骤 4.4：增强搜索面板组件
**目标**：增强搜索功能以支持复杂筛选和历史记录

**具体任务**：
- [ ] 扩展 `src/components/searchPanel/index.vue`
  - 支持动态筛选字段配置
  - 添加高级搜索功能
  - 实现搜索历史记录
- [ ] 实现智能搜索建议
  - 基于用户输入的智能提示
  - 历史搜索记录建议
  - 热门搜索词推荐
- [ ] 添加搜索结果优化
  - 搜索结果高亮
  - 相关性排序
  - 搜索结果统计
- [ ] 优化搜索性能
  - 防抖搜索输入
  - 搜索结果缓存
  - 分页搜索支持

**产出物**：
- 增强的搜索面板组件
- 智能搜索功能
- 优化的搜索性能

**验收标准**：
- 搜索功能强大易用
- 智能提示准确有用
- 搜索响应速度快

---

## 🧪 阶段五：测试和优化（第4周）

### 步骤 5.1：重构组件测试
**目标**：更新组件测试以适应新的架构

**具体任务**：
- [ ] 创建 Protobuf 测试工具
  - Mock Protobuf 消息对象
  - 测试数据生成器
  - 类型验证测试工具
- [ ] 重构动态表单测试
  - 测试 Protobuf 配置渲染
  - 验证表单验证功能
  - 测试 gRPC 提交流程
- [ ] 更新业务组件测试
  - 适配新的 API 调用方式
  - 测试状态管理集成
  - 验证错误处理机制
- [ ] 添加性能测试
  - 组件渲染性能测试
  - 大数据量处理测试
  - 内存使用测试

**产出物**：
- 完整的组件测试套件
- Protobuf 测试工具包
- 性能测试报告

**验收标准**：
- 所有测试通过
- 测试覆盖率达到要求
- 性能指标满足预期

---

### 步骤 5.2：实现 E2E 测试
**目标**：建立端到端的用户流程测试

**具体任务**：
- [ ] 创建用户认证流程测试
  - 测试 gRPC 和 REST 双协议登录
  - 验证用户状态管理
  - 测试权限验证流程
- [ ] 创建业务功能测试
  - 测试数据列表操作
  - 验证表单提交流程
  - 测试权限管理功能
- [ ] 实现协议切换测试
  - 模拟网络异常场景
  - 验证自动降级机制
  - 测试协议切换无缝性
- [ ] 添加用户体验测试
  - 页面加载速度测试
  - 交互响应时间测试
  - 错误恢复能力测试

**产出物**：
- 完整的 E2E 测试套件
- 协议切换测试用例
- 用户体验测试报告

**验收标准**：
- 所有 E2E 测试通过
- 协议切换机制可靠
- 用户体验指标达标

---

### 步骤 5.3：性能优化和监控
**目标**：优化应用性能并建立监控机制

**具体任务**：
- [ ] 实现代码分割和懒加载
  - 路由级别的代码分割
  - 组件懒加载优化
  - Protobuf 类型懒加载
- [ ] 优化网络请求
  - 请求合并和批处理
  - 响应数据压缩
  - 连接复用优化
- [ ] 实现客户端缓存策略
  - API 响应缓存
  - 静态资源缓存
  - 离线数据支持
- [ ] 添加性能监控
  - 关键指标收集
  - 错误追踪和报告
  - 用户行为分析

**产出物**：
- 优化的应用性能
- 完善的缓存策略
- 实时性能监控

**验收标准**：
- 应用加载速度提升
- 网络请求效率优化
- 监控数据准确完整

---

### 步骤 5.4：部署配置和文档
**目标**：完善部署配置和技术文档

**具体任务**：
- [ ] 优化构建配置
  - 生产环境构建优化
  - 资源压缩和分包
  - 构建缓存策略
- [ ] 配置部署环境
  - 多环境配置管理
  - 环境变量注入
  - 部署脚本更新
- [ ] 编写技术文档
  - API 调用指南
  - 组件使用文档
  - 开发规范说明
- [ ] 创建故障排查指南
  - 常见问题解决方案
  - 调试工具使用指南
  - 性能问题排查

**产出物**：
- 优化的构建和部署配置
- 完整的技术文档
- 故障排查指南

**验收标准**：
- 构建部署流程顺畅
- 文档内容完整准确
- 故障排查指南实用

---

## 📊 质量控制和里程碑

### 里程碑检查点

| 里程碑 | 时间节点 | 验收标准 | 风险评估 |
|--------|----------|----------|----------|
| **M1 - 环境配置** | 第1周末 | 构建工具配置完成，Protobuf 编译正常 | 低风险 |
| **M2 - API 重构** | 第2周末 | API 层迁移完成，双协议支持 | 中风险 |
| **M3 - 状态管理** | 第3周中 | 状态管理迁移完成，组件适配开始 | 中风险 |
| **M4 - 组件适配** | 第3周末 | 核心组件迁移完成，功能验证通过 | 高风险 |
| **M5 - 测试优化** | 第4周末 | 所有测试通过，性能优化完成 | 低风险 |

### 风险缓解策略

| 风险项 | 缓解措施 | 应急预案 |
|--------|----------|----------|
| **组件适配复杂** | 渐进式迁移，保持向后兼容 | 回滚到 GraphQL 版本 |
| **性能下降** | 持续性能监控，及时优化 | 性能降级方案 |
| **用户体验受影响** | 充分测试，用户反馈收集 | 快速修复和迭代 |
| **学习成本高** | 团队培训，文档完善 | 专家支援，延长周期 |

### 质量门禁

**每个阶段完成前必须通过：**
- [ ] 功能测试全部通过
- [ ] 性能指标达到要求
- [ ] 用户体验测试通过
- [ ] 代码审查完成
- [ ] 文档更新完成
- [ ] 安全检查通过

---

## 🚀 部署和上线策略

### 分阶段发布计划

1. **内测版本**（开发团队）
   - 功能完整性验证
   - 基础性能测试
   - 问题收集和修复

2. **灰度发布**（小范围用户）
   - 真实用户环境验证
   - 性能监控和优化
   - 用户反馈收集

3. **全量发布**（所有用户）
   - 全面功能验证
   - 持续监控和优化
   - 用户支持和培训

### 回滚和应急预案

- **快速回滚**：保留 GraphQL 版本，一键切换
- **功能降级**：关键功能降级到基础版本
- **用户通知**：及时的用户通知和解决方案
- **技术支持**：7x24 小时技术支持团队

---

> **总结**：本前端迁移计划采用渐进式重构策略，确保用户体验不受影响的同时完成技术架构升级。重点关注组件兼容性、性能优化和用户体验保持。 