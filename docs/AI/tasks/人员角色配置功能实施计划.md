# 人员角色配置功能实施计划

## 一、需求概述

实现人员角色配置功能：

1. 为人员分配角色（多选）
2. 查看人员拥有的资源（资源树展示）
3. 集成到新增/编辑人员页面
4. 角色变更后实时预览资源树
5. 清理错误代码

## 二、技术约束

- 接口统一使用 query 参数
- 前后端分离：Vue 3 + Naive UI / NestJS + Prisma
- 使用 Proto 生成类型定义

## 三、实施步骤

### 阶段一：后端接口实现

#### 1.1 用户角色查询接口

**文件**：`user.controller.ts` **接口**：`GET /api/users/roles?phone={phone}` **功能**：查询用户已分配的角色列表

#### 1.2 用户角色分配接口

**文件**：`user.controller.ts` **接口**：`POST /api/users/roles?phone={phone}` Body: `{ roleIds: string[] }` **功能**：覆盖式分配角色，使用事务保证一致性

#### 1.3 用户资源查询接口

**文件**：`user.controller.ts` **接口**：`GET /api/users/resources?phone={phone}` **功能**：聚合用户所有角色的资源，返回资源树和平铺列表

#### 1.4 UserService 业务逻辑

**文件**：`user.service.ts` **新增方法**：

- `getUserRoles(phone)` - 查询用户角色
- `assignUserRoles(phone, roleIds)` - 分配角色（事务处理）
- `getUserResources(phone)` - 获取用户资源树

#### 1.5 更新用户列表/详情接口

**文件**：`user.controller.ts` / `user.service.ts` **修改**：

- `findAll()` 支持按 `roleIds` 过滤，返回 `roleIds` 和 `roles`
- `findOne()` 返回 `roleIds` 和 `roles`
- 移除所有 `roleIds: []` 硬编码

### 阶段二：前端 API 层

#### 2.1 新增用户角色管理 API

**文件**：`apps/naive-admin/src/request/api/users.ts` **新增函数**：

- `getUserRoles(phone)` - 获取用户角色
- `assignUserRoles(phone, roleIds)` - 分配角色
- `getUserResources(phone)` - 获取用户资源

**修改**：更新 `getUserList` 和 `getUserByPhone` 返回类型，包含 `roles` 字段

#### 2.2 清理错误 API 引用

**文件**：`apps/naive-admin/src/request/api/role.ts` **清理**：移除未实现的用户相关 API

### 阶段三：前端组件实现

#### 3.1 创建角色分配组件

**文件**：`apps/naive-admin/src/views/system/user/components/RoleAssignment.vue` **功能**：角色多选、实时预览资源树 **Props**：`phone?`, `initialRoleIds?` **Emits**：`update:roleIds`

#### 3.2 重构新增人员页面

**文件**：`apps/naive-admin/src/views/system/user/CreateUserModal.vue` **修改**：引入 `RoleAssignment` 组件，提交时包含 `roleIds`

#### 3.3 创建编辑人员页面

**文件**：`apps/naive-admin/src/views/system/user/EditUserModal.vue` **功能**：编辑用户信息、角色分配、资源预览

#### 3.4 更新用户列表页面

**文件**：`apps/naive-admin/src/views/system/user/list.vue` **修改**：实现 `handleEdit`、引入 `EditUserModal`、更新角色显示逻辑、移除 `AssignRolesModal`

### 阶段四：清理错误代码

#### 4.1 删除错误组件

- `AssignRolesModal.vue`
- `UserAssignModal.vue`

#### 4.2 清理 API 引用

**文件**：`apps/naive-admin/src/request/api/role.ts` 移除未实现的函数引用

#### 4.3 清理 Store 引用

检查并移除 `useRoleStore` 相关引用

### 阶段五：测试验证

- 后端接口测试（角色查询、分配、资源查询）
- 前端功能测试（新增/编辑、资源预览）
- 集成测试（完整流程）

## 四、数据流

**新增人员**：填写信息 → 选择角色 → 预览资源 → 创建用户 → 分配角色

**编辑人员**：加载信息/角色/资源 → 修改 → 实时预览 → 更新用户/角色

**资源预览**：选择角色 → 调用接口 → 聚合资源 → 构建树 → 渲染

## 五、注意事项

1. 接口统一使用 query 参数
2. 角色分配使用事务保证一致性
3. 资源预览使用防抖优化
4. 完善错误处理
5. 使用 Proto 类型确保类型安全
6. 彻底清理错误代码

## 六、文件清单

### 后端

- `server/nest-main/src/modules/users/user.controller.ts`（修改）
- `server/nest-main/src/modules/users/user.service.ts`（修改）

### 前端

- `apps/naive-admin/src/request/api/users.ts`（修改）
- `apps/naive-admin/src/request/api/role.ts`（清理）
- `apps/naive-admin/src/views/system/user/CreateUserModal.vue`（修改）
- `apps/naive-admin/src/views/system/user/EditUserModal.vue`（新建）
- `apps/naive-admin/src/views/system/user/components/RoleAssignment.vue`（新建）
- `apps/naive-admin/src/views/system/user/list.vue`（修改）
- `apps/naive-admin/src/views/system/user/components/AssignRolesModal.vue`（删除）
- `apps/naive-admin/src/views/system/user/components/UserAssignModal.vue`（删除）

## 七、实施顺序

1. 后端接口实现（1.1-1.5）
2. 前端 API 层（2.1-2.2）
3. 前端组件实现（3.1-3.4）
4. 清理错误代码（4.1-4.3）
5. 测试验证（5.1-5.3）

## 八、验收标准

1. ✅ 新增人员时可分配角色并预览资源树
2. ✅ 编辑人员时可修改角色并实时预览资源树
3. ✅ 用户列表正确显示角色名称
4. ✅ 所有接口使用 query 参数
5. ✅ 错误代码已完全移除
6. ✅ 资源树正确聚合用户所有角色的资源
7. ✅ 角色分配支持多选
8. ✅ 数据一致性保证（事务处理）
