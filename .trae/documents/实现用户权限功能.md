# 实现用户权限功能

## 需求分析
1. 改造 `auth/profile` 接口：
   - 只返回用户关键信息：phone、username
   - 返回用户拥有的权限树：
     - menuTree：页面级别权限树（用于前端渲染菜单）
     - resources：所有权限（拍平后下发，用于前端判断页面权限、模块权限）
2. 调整 `login` 接口：
   - 返回的 user 字段只包含 phone 和 username
   - 移除 role 相关数据

## 技术方案

### 1. 定义 Proto 类型
- 修改 `protos/users.proto` 文件，添加新的响应类型
- 定义 `ProfileResponse` 类型，包含用户关键信息和权限树
- 调整 `AuthResponse` 中的 `user` 字段类型

### 2. 生成 TypeScript 类型
- 运行 `pnpm run generate:types` 生成新的类型定义

### 3. 修改 UserController
- 改造 `getCurrentUser` 方法：
  - 调用 `userService.getUserResources` 获取权限数据
  - 组装返回数据，包含 menuTree 和 resources 字段
  - 只返回用户关键信息
- 调整 `login` 方法：
  - 简化返回的 user 字段，只包含 phone 和 username

### 4. 验证功能
- 运行测试，确保接口正常工作
- 验证返回数据格式符合要求

## 实施步骤

### 1. 修改 Proto 文件
```protobuf
// protos/users.proto
syntax = "proto3";
package users;

// 资源项
message ResourceItem {
  string id = 1;
  string name = 2;
  string parentName = 3;
  int32 type = 4;
  string icon = 5;
  string parentId = 6;
  int32 sortOrder = 7;
  bool isActive = 8;
  int32 level = 9;
  string resCode = 10;
  string path = 11;
  repeated ResourceItem children = 12;
}

// 权限树响应
message PermissionTree {
  repeated ResourceItem menuTree = 1;
  repeated ResourceItem resources = 2;
}

// 精简用户信息
message SimpleUser {
  string phone = 1;
  string username = 2;
}

// 认证响应
expect interface AuthResponse {
  user?: SimpleUser | null;
  token: string;
  expiresAt: string;
}

// 个人资料响应
expect interface ProfileResponse {
  user: SimpleUser;
  permissions: PermissionTree;
}
```

### 2. 生成 TypeScript 类型
```bash
pnpm run generate:types
```

### 3. 修改 UserController

#### 3.1 修改 `getCurrentUser` 方法
```typescript
@Get('auth/profile')
@ApiOperation({
  summary: '获取当前用户信息',
  description: '获取当前登录用户的详细信息及权限树'
})
async getCurrentUser(@Query('phone') phone: string): Promise<ApiResponse<ProfileResponse>> {
  // 验证手机号格式
  Validator.phone(phone)

  // 获取用户基本信息
  const user = await this.userService.findOne(phone)
  this.assertDataExists(user, '用户', phone)

  // 获取用户权限树
  const { tree, list } = await this.userService.getUserResources(phone)

  // 组装响应数据
  const profileResponse: ProfileResponse = {
    user: {
      phone: user.phone,
      username: user.username || ''
    },
    permissions: {
      menuTree: tree,
      resources: list
    }
  }

  return this.success(profileResponse, '获取用户信息成功')
}
```

#### 3.2 修改 `login` 方法
```typescript
@Post('auth/login')
@HttpCode(HttpStatus.OK)
@ApiOperation({
  summary: '用户登录',
  description: '使用手机号和密码进行用户登录认证'
})
async login(@Body() loginRequest: LoginRequest): Promise<ApiResponse<AuthResponse>> {
  // 基础格式验证
  Validator.phone(loginRequest.phone)
  Validator.password(loginRequest.password)

  // 执行登录逻辑
  const result = await this.userService.login({
    phone: loginRequest.phone,
    password: loginRequest.password
  })

  if (!result) {
    throw new UnauthorizedException('手机号或密码错误')
  }

  // 获取用户基本信息
  const user = await this.userService.findOne(loginRequest.phone)

  // 直接组装响应数据
  const authResponse: AuthResponse = {
    user: {
      phone: user!.phone,
      username: user!.username || ''
    },
    token: result.token,
    expiresAt: this.formatDateTime(new Date(Date.now() + 24 * 60 * 60 * 1000))
  }

  return this.success(authResponse, '登录成功')
}
```

### 4. 验证功能
```bash
# 运行测试
pnpm test

# 启动服务
pnpm start:dev

# 使用 API 工具测试接口
# 1. 测试 login 接口，验证返回的 user 字段只包含 phone 和 username
# 2. 测试 auth/profile 接口，验证返回数据包含 menuTree 和 resources 字段
```

## 预期结果
1. `login` 接口返回的数据结构：
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "user": {
      "phone": "13800138000",
      "username": "管理员"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresAt": "2023-10-01T12:00:00Z"
  }
}
```

2. `auth/profile` 接口返回的数据结构：
```json
{
  "code": 0,
  "message": "获取用户信息成功",
  "data": {
    "user": {
      "phone": "13800138000",
      "username": "管理员"
    },
    "permissions": {
      "menuTree": [
        {
          "id": "res_1",
          "name": "系统管理",
          "type": 1,
          "icon": "settings",
          "level": 1,
          "resCode": "sys:manage",
          "path": "/sys/manage",
          "children": [
            {
              "id": "res_1_1",
              "name": "用户管理",
              "type": 2,
              "icon": "user",
              "level": 2,
              "resCode": "sys:user:manage",
              "path": "/sys/manage/users"
            }
          ]
        }
      ],
      "resources": [
        {
          "id": "res_1",
          "name": "系统管理",
          "type": 1,
          "level": 1,
          "resCode": "sys:manage",
          "path": "/sys/manage"
        },
        {
          "id": "res_1_1",
          "name": "用户管理",
          "type": 2,
          "level": 2,
          "resCode": "sys:user:manage",
          "path": "/sys/manage/users"
        }
      ]
    }
  }
}
```

## 注意事项
1. 严格遵循类型驱动开发，确保所有类型定义准确
2. 保持接口向后兼容，避免破坏现有功能
3. 确保权限树生成逻辑正确，只返回用户实际拥有的权限
4. 优化响应数据大小，避免不必要的字段返回
5. 遵循后端开发规范，特别是错误处理和日志记录要求