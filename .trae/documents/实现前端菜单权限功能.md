# å®ç°å‰ç«¯èœå•æƒé™åŠŸèƒ½

## éœ€æ±‚åˆ†æ
1. è°ƒç”¨ `auth/profile` æ¥å£ï¼Œè·å– `menuTree` å’Œ `resources` æ•°æ®
2. ç»“åˆ `menu.ts` store çš„é€»è¾‘ï¼Œå°†æ¥å£æ•°æ®è½¬æ¢ä¸º Menu éœ€è¦çš„æ•°æ®ï¼Œå®ç°èœå•å±•ç¤ºä¸æ¥å£ä¸‹å‘æ•°æ®ä¸€è‡´
3. ä¼˜åŒ– `user.ts` storeï¼Œç»“åˆç”¨æˆ·ä¿¡æ¯è¿”å›å€¼çš„è°ƒæ•´ï¼Œæ–°å¢ `resources` å­—æ®µä¿å­˜ç”¨æˆ·èµ„æº

## æŠ€æœ¯æ–¹æ¡ˆ

### 1. æ›´æ–° API æ¨¡å—
- ä¿®æ”¹ `getCurrentUser` æ–¹æ³•ï¼Œè¿”å›åŒ…å«æƒé™æ ‘çš„ç±»å‹
- æ›´æ–°è¿”å›ç±»å‹å®šä¹‰ï¼Œé€‚é…æ–°çš„ `ProfileResponse` ç±»å‹

### 2. æ›´æ–° User Store
- æ–°å¢ `resources` å­—æ®µä¿å­˜ç”¨æˆ·èµ„æº
- æ›´æ–° `userInfo` ç±»å‹ï¼ŒåªåŒ…å« `phone` å’Œ `username`
- ä¿®æ”¹ `login` æ–¹æ³•ï¼Œé€‚é…æ–°çš„è¿”å›ç±»å‹
- æ–°å¢ `getProfile` æ–¹æ³•ï¼Œè°ƒç”¨ `auth/profile` æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘

### 3. æ›´æ–° Menu Store
- ä¿®æ”¹ `menu.ts`ï¼Œä»æ¥å£è·å–èœå•æ ‘
- æ–°å¢å°†èµ„æºæ ‘è½¬æ¢ä¸ºèœå•æ ‘çš„å·¥å…·å‡½æ•°
- æ›´æ–°èœå•ç”Ÿæˆé€»è¾‘ï¼Œä½¿ç”¨æ¥å£è¿”å›çš„æ•°æ®

### 4. æ˜ç¡® auth/profile è°ƒç”¨æ—¶æœº
- **ç™»å½•æˆåŠŸå**ï¼šè·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘
- **åº”ç”¨å¯åŠ¨æ—¶**ï¼šå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘
- **è·¯ç”±å®ˆå«ä¸­**ï¼šåœ¨éœ€è¦æ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

### 5. å®ç°èœå•è½¬æ¢é€»è¾‘
- åˆ›å»ºå°† `ResourceTree` è½¬æ¢ä¸º `IMenuItem` çš„å·¥å…·å‡½æ•°
- å®ç°èœå•æ ‘çš„æ‰å¹³åŒ–å¤„ç†

## å®æ–½æ­¥éª¤

### 1. æ›´æ–° API ç±»å‹å’Œæ¥å£

#### 1.1 æ›´æ–° API æ–¹æ³•
```typescript
// src/request/api/users.ts
import type { ProfileResponse, SimpleUser } from '@/shared/users'
import type { ResourceTree, Resource } from '@/shared/resource'

// æ›´æ–°ç±»å‹å®šä¹‰
export type UserInfo = SimpleUser

export interface UserProfileResponse {
  user: SimpleUser;
  permissions: {
    menuTree: ResourceTree[];
    resources: Resource[];
  };
}

// æ›´æ–° getCurrentUser æ–¹æ³•
export const getCurrentUser = async () => {
  return get<void, ProfileResponse>('/api/auth/profile')
}
```

### 2. æ›´æ–° User Store

#### 2.1 ä¿®æ”¹ user.ts store
```typescript
// src/store/modules/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { login as apiLogin, logout as apiLogout, getCurrentUser } from '@/request/api/users'
import type { SimpleUser, ProfileResponse } from '@/shared/users'
import type { Resource } from '@/shared/resource'

export const useUserStore = defineStore(
  'user',
  () => {
    // ========================================
    // ğŸ“Š çŠ¶æ€å®šä¹‰
    // ========================================

    // ç”¨æˆ·ä¿¡æ¯ï¼ˆåªåŒ…å«phoneå’Œusernameï¼‰
    const userInfo = ref<SimpleUser | null>(null)
    const authToken = ref<string | null>(null)
    // ç”¨æˆ·èµ„æºåˆ—è¡¨
    const resources = ref<Resource[]>([])

    // ç™»å½•çŠ¶æ€
    const isLoggedIn = computed(() => {
      return !!(authToken.value && userInfo.value)
    })

    // ========================================
    // ğŸ” ç”¨æˆ·è®¤è¯ç›¸å…³æ–¹æ³•
    // ========================================

    /**
     * ç”¨æˆ·ç™»å½•
     * @param phone æ‰‹æœºå·
     * @param password å¯†ç 
     * @returns Promise<boolean> ç™»å½•æ˜¯å¦æˆåŠŸ
     */
    async function login(phone: string, password: string): Promise<boolean> {
      try {
        const [authResponse, error] = await apiLogin({ phone, password })

        if (error) {
          return false
        }

        if (authResponse && authResponse.data) {
          userInfo.value = authResponse.data.user || null
          authToken.value = authResponse.data.token

          // ç™»å½•æˆåŠŸåç«‹å³è°ƒç”¨ auth/profile è·å–å®Œæ•´ä¿¡æ¯å’Œæƒé™æ ‘
          await getProfile(phone)

          return true
        }

        return false
      } catch (error) {
        console.error('[User Store] Login failed:', error)
        return false
      }
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘ï¼ˆè°ƒç”¨ auth/profile æ¥å£ï¼‰
     * @returns Promise<boolean> è·å–æ˜¯å¦æˆåŠŸ
     */
    async function getProfile(): Promise<boolean> {
      try {
        const [profileResponse, error] = await getCurrentUser()

        if (error) {
          return false
        }

        if (profileResponse && profileResponse.data) {
          userInfo.value = profileResponse.data.user || null
          resources.value = profileResponse.data.permissions?.resources || []

          // è§¦å‘èœå•æ›´æ–°
          const menuStore = useMenuStore()
          menuStore.updateMenuTree(profileResponse.data.permissions?.menuTree || [])

          return true
        }

        return false
      } catch (error) {
        console.error('[User Store] Get profile failed:', error)
        return false
      }
    }

    /**
     * ç”¨æˆ·ç™»å‡º
     */
    async function logout(): Promise<void> {
      try {
        // è°ƒç”¨ç™»å‡ºAPI
        await apiLogout()
      } catch (error) {
        console.error('[User Store] Logout failed:', error)
      } finally {
        // æ¸…é™¤çŠ¶æ€
        userInfo.value = null
        authToken.value = null
        resources.value = []

        // é‡ç½®èœå•
        const menuStore = useMenuStore()
        menuStore.resetMenuTree()
      }
    }

    /**
     * æ£€æŸ¥ç™»å½•çŠ¶æ€
     */
    function checkLoginStatus(): boolean {
      return isLoggedIn.value && !!authToken.value
    }

    return {
      // çŠ¶æ€
      userInfo,
      authToken,
      resources,

      // è®¡ç®—å±æ€§
      isLoggedIn,

      // è®¤è¯æ–¹æ³•
      login,
      logout,
      getProfile,
      checkLoginStatus
    }
  },
  {
    persist: {
      key: 'user',
      storage: localStorage,
      pick: ['userInfo', 'authToken']
    }
  }
)
```

### 3. æ›´æ–° Menu Store

#### 3.1 ä¿®æ”¹ menu.ts store
```typescript
// src/store/modules/menu.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { ResourceTree } from '@/shared/resource'

export const useMenuStore = defineStore('menu', () => {
  // ========================================
  // ğŸ“Š çŠ¶æ€å®šä¹‰
  // ========================================

  const activeMenuKey = ref<string>('') // å½“å‰è·¯ç”±è·¯å¾„
  const menuTree = ref<IMenuItem[]>([]) // èœå•æ ‘
  const flatAllMenuList = ref<IMenuItem[]>([]) // æ‰å¹³åŒ–èœå•åˆ—è¡¨
  const collapsed = ref<boolean>(false) // èœå•æ˜¯å¦æ”¶èµ·

  // ========================================
  // ğŸ” è®¡ç®—å±æ€§
  // ========================================

  const menuRoutes = computed(() => {
    const result: IMenuItem[] = []
    let curMenu = flatAllMenuList.value.find((item) => item.path === activeMenuKey.value)
    if (curMenu) {
      result.push(curMenu)
      while (curMenu.parent) {
        result.unshift(curMenu.parent)
        curMenu = curMenu.parent
      }
    }
    return result
  })

  // ========================================
  // ğŸ”§ å·¥å…·æ–¹æ³•
  // ========================================

  /**
   * å°† ResourceTree è½¬æ¢ä¸º IMenuItem
   * @param resourceTree èµ„æºæ ‘
   * @param parent çˆ¶èœå•é¡¹
   * @returns èœå•é¡¹
   */
  function convertResourceToMenuItem(resourceTree: ResourceTree, parent: IMenuItem | null = null): IMenuItem {
    return {
      path: resourceTree.path,
      name: resourceTree.name,
      icon: resourceTree.icon || '',
      activeMenuPath: '',
      parent,
      children: resourceTree.children ? resourceTree.children.map(child => convertResourceToMenuItem(child)) : []
    }
  }

  /**
   * å°† ResourceTree æ•°ç»„è½¬æ¢ä¸º IMenuItem æ•°ç»„
   * @param resourceTrees èµ„æºæ ‘æ•°ç»„
   * @returns èœå•é¡¹æ•°ç»„
   */
  function convertResourceTreesToMenuItems(resourceTrees: ResourceTree[]): IMenuItem[] {
    return resourceTrees.map(resourceTree => convertResourceToMenuItem(resourceTree))
  }

  /**
   * æ‰å¹³åŒ–èœå•æ ‘
   * @param menuItems èœå•é¡¹æ•°ç»„
   * @param parent çˆ¶èœå•é¡¹
   * @returns æ‰å¹³åŒ–çš„èœå•é¡¹æ•°ç»„
   */
  function flattenMenuItems(menuItems: IMenuItem[], parent: IMenuItem | null = null): IMenuItem[] {
    const result: IMenuItem[] = []

    menuItems.forEach(item => {
      const menuItem: IMenuItem = {
        ...item,
        parent
      }
      result.push(menuItem)

      if (item.children && item.children.length > 0) {
        result.push(...flattenMenuItems(item.children, menuItem))
      }
    })

    return result
  }

  // ========================================
  // ğŸ¯ æ ¸å¿ƒæ–¹æ³•
  // ========================================

  /**
   * ä¼˜å…ˆè®¾ç½® activeMenuPathï¼Œå¦åˆ™è®¾ç½®å½“å‰è·¯å¾„
   */
  function setActiveMenuKey(path: string) {
    const curMenu = flatAllMenuList.value.find((item) => item.path === path)
    if (curMenu) {
      activeMenuKey.value = curMenu.activeMenuPath || path
    } else {
      activeMenuKey.value = path
    }
  }

  /**
   * æ›´æ–°èœå•æ ‘
   * @param resourceTrees èµ„æºæ ‘æ•°ç»„
   */
  function updateMenuTree(resourceTrees: ResourceTree[]) {
    // å°†èµ„æºæ ‘è½¬æ¢ä¸ºèœå•é¡¹æ•°ç»„
    const menuItems = convertResourceTreesToMenuItems(resourceTrees)
    // æ‰å¹³åŒ–èœå•æ ‘
    const flattenedMenuItems = flattenMenuItems(menuItems)

    menuTree.value = menuItems
    flatAllMenuList.value = flattenedMenuItems
  }

  /**
   * é‡ç½®èœå•æ ‘
   */
  function resetMenuTree() {
    menuTree.value = []
    flatAllMenuList.value = []
  }

  /**
   * åˆ‡æ¢èœå•æ”¶èµ·çŠ¶æ€
   */
  function toggleCollapse() {
    collapsed.value = !collapsed.value
  }

  return {
    // çŠ¶æ€
    activeMenuKey,
    menuTree,
    flatAllMenuList,
    collapsed,

    // è®¡ç®—å±æ€§
    menuRoutes,

    // æ–¹æ³•
    setActiveMenuKey,
    updateMenuTree,
    resetMenuTree,
    toggleCollapse
  }
})
```

### 4. æ˜ç¡® auth/profile è°ƒç”¨æ—¶æœº

#### 4.1 åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨
```typescript
// src/main.ts
import { createApp } from 'vue'
import App from './App.vue'
import { useUserStore } from './store/modules/user'
import { createPinia } from 'pinia'

const app = createApp(App)
const pinia = createPinia()
app.use(pinia)

// åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
const userStore = useUserStore()
if (userStore.checkLoginStatus()) {
  // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘
  userStore.getProfile().catch(error => {
    console.error('Failed to get user profile:', error)
    // å¦‚æœè·å–å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•
    userStore.logout()
  })
}

app.mount('#app')
```

#### 4.2 è·¯ç”±å®ˆå«ä¸­è°ƒç”¨
```typescript
// src/router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import { useUserStore } from '@/store/modules/user'

const router = createRouter({
  history: createWebHistory(),
  routes
})

router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore()

  // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯æˆ–èµ„æºï¼Œé‡æ–°è·å–
  if (userStore.checkLoginStatus() && !userStore.userInfo) {
    const success = await userStore.getProfile()
    if (!success) {
      // è·å–å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
      next('/login')
      return
    }
  }

  // å…¶ä»–è·¯ç”±å®ˆå«é€»è¾‘
  next()
})
```

#### 4.3 ç™»å½•æˆåŠŸåè°ƒç”¨
```typescript
// å·²åœ¨ userStore.login æ–¹æ³•ä¸­å®ç°
// ç™»å½•æˆåŠŸåç«‹å³è°ƒç”¨ getProfile è·å–å®Œæ•´ä¿¡æ¯å’Œæƒé™æ ‘
```

### 5. éªŒè¯åŠŸèƒ½

#### 5.1 è¿è¡Œå¼€å‘æœåŠ¡å™¨
```bash
pnpm run dev:admin
```

#### 5.2 æµ‹è¯•åŠŸèƒ½
- ç™»å½•ç³»ç»Ÿï¼Œæ£€æŸ¥èœå•æ˜¯å¦æ­£ç¡®å±•ç¤º
- éªŒè¯èœå•ç»“æ„ä¸æ¥å£è¿”å›çš„æ•°æ®ä¸€è‡´
- éªŒè¯ç”¨æˆ·èµ„æºæ˜¯å¦æ­£ç¡®ä¿å­˜åˆ° store ä¸­
- åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯èœå•æ˜¯å¦é‡æ–°åŠ è½½
- ç™»å‡ºç³»ç»Ÿï¼ŒéªŒè¯èœå•æ˜¯å¦é‡ç½®

## é¢„æœŸç»“æœ

1. **åº”ç”¨å¯åŠ¨æ—¶**ï¼š
   - æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
   - å¦‚æœå·²ç™»å½•ï¼Œè°ƒç”¨ `auth/profile` è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘
   - æ›´æ–°èœå•æ ‘

2. **ç”¨æˆ·ç™»å½•å**ï¼š
   - è°ƒç”¨ `auth/login` ç™»å½•
   - ç™»å½•æˆåŠŸåè°ƒç”¨ `auth/profile` è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ ‘
   - æ›´æ–° `userStore` å’Œ `menuStore`

3. **èœå•å±•ç¤º**ï¼š
   - èœå•ç»“æ„ä¸æ¥å£è¿”å›çš„ `menuTree` ä¸€è‡´
   - æ”¯æŒèœå•æ”¶èµ·/å±•å¼€
   - æ”¯æŒå½“å‰èœå•é«˜äº®

4. **ç”¨æˆ·èµ„æº**ï¼š
   - `userStore` ä¸­çš„ `resources` ä¿å­˜ç”¨æˆ·æ‰€æœ‰èµ„æº
   - å¯ç”¨äºå‰ç«¯æƒé™åˆ¤æ–­

## éµå¾ªå‰ç«¯å¼€å‘è§„èŒƒ

1. **ç»„ä»¶ç»“æ„ä¸ç»„ç»‡**ï¼š
   - æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ä»£ç 
   - æ¸…æ™°çš„ç›®å½•ç»“æ„

2. **TypeScript ç±»å‹ä½¿ç”¨**ï¼š
   - ä½¿ç”¨ proto ç”Ÿæˆçš„ç±»å‹
   - é¿å…ä½¿ç”¨ `any` ç±»å‹
   - æ¸…æ™°çš„ç±»å‹å®šä¹‰

3. **API è¯·æ±‚ä¸å“åº”å¤„ç†**ï¼š
   - ç»Ÿä¸€çš„è¯·æ±‚å°è£…
   - æ˜ç¡®çš„è¿”å›ç±»å‹
   - é”™è¯¯å¤„ç†æœºåˆ¶

4. **çŠ¶æ€ç®¡ç†**ï¼š
   - ä½¿ç”¨ Pinia è¿›è¡ŒçŠ¶æ€ç®¡ç†
   - æ¸…æ™°çš„çŠ¶æ€å®šä¹‰å’Œæ–¹æ³•
   - åˆç†çš„çŠ¶æ€æŒä¹…åŒ–

5. **ä»£ç é£æ ¼ä¸å‘½åè§„èŒƒ**ï¼š
   - é©¼å³°å‘½å
   - æ¸…æ™°çš„æ³¨é‡Š
   - æ¨¡å—åŒ–è®¾è®¡

6. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æŒ‰éœ€åŠ è½½
   - åˆç†çš„ç¼“å­˜ç­–ç•¥

7. **å®‰å…¨è§„èŒƒ**ï¼š
   - å‰åç«¯åŒé‡éªŒè¯
   - æ•æ„Ÿæ•°æ®å¤„ç†
   - æƒé™æ§åˆ¶

## å¼€å‘æ³¨æ„äº‹é¡¹

1. **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿æ‰€æœ‰ç±»å‹å®šä¹‰æ­£ç¡®ï¼Œé¿å…ç±»å‹é”™è¯¯
2. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰å¼‚æ­¥è¯·æ±‚éƒ½è¦æœ‰é”™è¯¯å¤„ç†
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„è¯·æ±‚å’Œè®¡ç®—
4. **ä»£ç å¯è¯»æ€§**ï¼šä¿æŒä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
5. **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æœ‰æµ‹è¯•è¦†ç›–

## åç»­ä¼˜åŒ–

1. **æ·»åŠ æƒé™åˆ¤æ–­ Hook**ï¼šåˆ›å»º `usePermission` Hookï¼Œæ–¹ä¾¿ç»„ä»¶ä¸­è¿›è¡Œæƒé™åˆ¤æ–­
2. **èœå•ç¼“å­˜**ï¼šæ·»åŠ èœå•ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è¯·æ±‚
3. **åŠ¨æ€è·¯ç”±**ï¼šæ ¹æ®æƒé™æ ‘åŠ¨æ€ç”Ÿæˆè·¯ç”±é…ç½®
4. **æƒé™æŒ‡ä»¤**ï¼šæ·»åŠ  v-permission æŒ‡ä»¤ï¼Œæ–¹ä¾¿åœ¨æ¨¡æ¿ä¸­è¿›è¡Œæƒé™æ§åˆ¶
