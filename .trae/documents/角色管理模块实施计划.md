# 角色管理模块测试数据准备和集成测试计划

## 1. 当前实现状态分析

### 已完成功能

| 任务编号 | 任务名称 | 完成状态 |
|----------|----------|----------|
| 6.2 | API 请求封装 | ✅ 完成 |
| 4.1 | 系统管理路由配置 | ✅ 完成 |
| 4.2 | 角色列表页面 | ✅ 完成 |
| 4.3 | 角色表单组件 | ✅ 完成 |
| 5.1 | 权限树组件 | ✅ 完成 |
| 5.2 | 权限管理界面 | ✅ 完成 |

### 未完成功能（重点关注任务7和8）

| 任务编号 | 任务名称 | 优先级 |
|----------|----------|--------|
| 7.1 | 创建基础测试角色 | 高 |
| 7.2 | 准备测试数据脚本 | 高 |
| 8.1 | 基础功能测试 | 高 |
| 8.2 | 权限管理测试 | 高 |
| 4.4 | 角色用户管理界面 | 中 |
| 6.1 | 角色状态管理 | 中 |
| 9.1 | 性能优化 | 中 |
| 9.2 | 交互优化 | 中 |
| 10.1 | 补充 users.proto role_ids 字段 | 中 |
| 10.2 | 整体验证测试 | 高 |

## 2. 任务7：测试数据准备

### 2.1 任务目标

准备完整的测试数据，包括基础角色和相关资源，确保角色管理模块的所有功能都能得到充分测试。

### 2.2 详细实施计划

#### 2.2.1 创建基础测试角色（任务7.1）

**操作项**：
- 创建 4 个基础测试角色：
  1. 管理员角色（admin）- 拥有全部资源权限
  2. 普通用户角色（user）- 拥有基础资源权限
  3. 查看者角色（viewer）- 拥有只读资源权限
  4. 自定义测试角色（test-role-1）- 拥有部分资源权限

**实施步骤**：
1. 登录系统管理界面
2. 访问角色管理页面（/system-manage/role）
3. 点击"新增角色"按钮
4. 填写角色信息并提交
5. 为每个角色分配相应的资源权限

**角色配置详情**：

| 角色名称 | 角色编码 | 描述 | 是否启用 | 是否超级管理员 | 权限范围 |
|----------|----------|------|----------|----------------|----------|
| 管理员 | admin | 系统管理员角色，拥有全部权限 | 是 | 是 | 所有资源 |
| 普通用户 | user | 普通用户角色，拥有基础权限 | 是 | 否 | 基础菜单和API |
| 查看者 | viewer | 只读角色，只能查看内容 | 是 | 否 | 只读权限 |
| 测试角色1 | test-role-1 | 自定义测试角色 | 是 | 否 | 部分资源 |

#### 2.2.2 准备测试数据脚本（任务7.2）

**操作项**：
- 创建 SQL 脚本：插入测试角色数据
- 创建 Seed 脚本：Prisma 数据库种子数据
- 创建清理脚本：清理测试数据

**实施步骤**：

1. **创建 SQL 测试数据脚本**
   - 文件路径：`/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/test-data.sql`
   - 内容包括：
     - 插入测试角色数据
     - 插入角色资源关联数据
     - 插入角色用户关联数据

2. **创建 Prisma Seed 脚本**
   - 文件路径：`/Users/staff/Documents/my-tools/vue3-mono/server/nest-main/prisma/seed/role-seed.ts`
   - 内容包括：
     - 使用 Prisma Client 创建测试角色
     - 分配资源权限
     - 关联测试用户

3. **创建测试数据清理脚本**
   - 文件路径：`/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/cleanup-data.sql`
   - 内容包括：
     - 删除测试角色资源关联
     - 删除测试角色用户关联
     - 删除测试角色

**脚本示例**：

```sql
-- test-data.sql
-- 插入测试角色
INSERT INTO roles (id, name, code, description, is_active, is_super_admin, created_at, updated_at) VALUES
('test-admin-1', '管理员', 'admin', '系统管理员角色', true, true, NOW(), NOW()),
('test-user-1', '普通用户', 'user', '普通用户角色', true, false, NOW(), NOW()),
('test-viewer-1', '查看者', 'viewer', '只读角色', true, false, NOW(), NOW()),
('test-role-1', '测试角色1', 'test-role-1', '自定义测试角色', true, false, NOW(), NOW());

-- 插入角色资源关联（示例）
INSERT INTO role_resources (role_id, resource_id, created_at, updated_at) VALUES
('test-admin-1', 'resource-1', NOW(), NOW()),
('test-admin-1', 'resource-2', NOW(), NOW()),
('test-user-1', 'resource-1', NOW(), NOW()),
('test-viewer-1', 'resource-3', NOW(), NOW());
```

## 3. 任务8：集成测试

### 3.1 任务目标

验证角色管理模块的所有功能是否正常工作，包括角色 CRUD、用户分配、资源权限分配等，确保前后端集成正常。

### 3.2 详细实施计划

#### 3.2.1 基础功能测试（任务8.1）

**测试范围**：
- 角色 CRUD 操作
- 用户分配/移除功能
- 前后端数据格式验证
- 错误处理机制

**测试用例**：

| 测试编号 | 测试场景 | 测试步骤 | 预期结果 |
|----------|----------|----------|----------|
| 8.1.1 | 创建角色 | 1. 访问角色列表页面<br>2. 点击"新增角色"按钮<br>3. 填写角色信息<br>4. 提交表单 | 角色创建成功，列表中显示新角色 |
| 8.1.2 | 编辑角色 | 1. 访问角色列表页面<br>2. 选择一个角色点击"编辑"按钮<br>3. 修改角色信息<br>4. 提交表单 | 角色信息更新成功，列表中显示更新后的角色 |
| 8.1.3 | 删除角色 | 1. 访问角色列表页面<br>2. 选择一个角色点击"删除"按钮<br>3. 确认删除 | 角色删除成功，列表中移除该角色 |
| 8.1.4 | 角色列表查询 | 1. 访问角色列表页面<br>2. 在搜索框中输入角色名称<br>3. 点击搜索按钮 | 列表显示匹配的角色 |
| 8.1.5 | 角色详情查看 | 1. 访问角色列表页面<br>2. 选择一个角色点击"详情"按钮 | 显示角色的详细信息 |

**测试工具**：
- 手动测试：使用浏览器访问系统进行测试
- 自动化测试：使用 Cypress 进行 E2E 测试

**测试文件**：
- `/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/e2e/basic-crud.cy.ts`

#### 3.2.2 权限管理测试（任务8.2）

**测试范围**：
- Resource 权限树获取功能
- 角色 Resource 权限分配功能
- 权限状态计算验证
- 权限更新功能

**测试用例**：

| 测试编号 | 测试场景 | 测试步骤 | 预期结果 |
|----------|----------|----------|----------|
| 8.2.1 | 权限树展示 | 1. 访问角色权限分配页面<br>2. 选择一个角色 | 正确显示该角色的资源权限树，包含已分配和未分配的资源 |
| 8.2.2 | 分配资源权限 | 1. 访问角色权限分配页面<br>2. 选择一个角色<br>3. 在权限树中选择多个资源<br>4. 点击"保存"按钮 | 资源权限分配成功，权限树中显示正确的选中状态 |
| 8.2.3 | 移除资源权限 | 1. 访问角色权限分配页面<br>2. 选择一个角色<br>3. 在权限树中取消选择已分配的资源<br>4. 点击"保存"按钮 | 资源权限移除成功，权限树中显示正确的选中状态 |
| 8.2.4 | 权限状态计算 | 1. 访问角色权限分配页面<br>2. 选择一个角色<br>3. 选择部分子资源 | 父资源显示部分选中状态（is_indeterminate = true） |
| 8.2.5 | 权限继承验证 | 1. 创建一个父角色并分配权限<br>2. 创建一个子角色并继承父角色权限<br>3. 查看子角色的权限树 | 子角色正确继承父角色的权限 |

**测试工具**：
- 手动测试：使用浏览器访问系统进行测试
- 自动化测试：使用 Cypress 进行 E2E 测试
- API 测试：使用 Postman 或 Insomnia 测试 API 接口

**测试文件**：
- `/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/e2e/permission-management.cy.ts`
- `/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/api/permission-api.test.ts`

## 4. 实施时间线

| 阶段 | 时间 | 交付物 |
|------|------|--------|
| 测试数据准备 | 2 天 | 测试数据脚本、Seed 脚本、清理脚本 |
| 基础功能测试 | 1 天 | 基础功能测试报告 |
| 权限管理测试 | 1 天 | 权限管理测试报告 |
| 问题修复 | 1 天 | 修复后的代码、修复报告 |
| 整体验证测试 | 1 天 | 整体验证测试报告 |

**总实施时间**: 6 天

## 5. 资源需求

### 5.1 人力资源

- 测试工程师：1 人
- 前端开发工程师：1 人（协助问题修复）
- 后端开发工程师：1 人（协助问题修复）

### 5.2 技术资源

- 测试环境：开发服务器
- 测试工具：Cypress、Postman、浏览器
- 数据库工具：PgAdmin 或其他 PostgreSQL 客户端

## 6. 成功标准

### 6.1 测试数据准备成功标准

- 测试数据脚本能够正确执行，插入测试角色数据
- Seed 脚本能够使用 Prisma Client 创建测试数据
- 清理脚本能够正确删除测试数据
- 测试数据覆盖所有角色类型和权限场景

### 6.2 集成测试成功标准

- 所有测试用例通过，通过率达到 100%
- 角色 CRUD 功能正常工作
- 资源权限分配功能正常工作
- 前后端数据格式一致
- 错误处理机制正常工作
- 权限状态计算准确
- 系统性能符合要求

## 7. 交付物

| 交付物名称 | 交付物类型 | 交付路径 |
|------------|------------|----------|
| 测试数据 SQL 脚本 | 脚本文件 | `/tests/role-management/test-data.sql` |
| Prisma Seed 脚本 | 脚本文件 | `/server/nest-main/prisma/seed/role-seed.ts` |
| 测试数据清理脚本 | 脚本文件 | `/tests/role-management/cleanup-data.sql` |
| 基础功能测试报告 | 文档 | `/tests/role-management/reports/basic-crud-test-report.md` |
| 权限管理测试报告 | 文档 | `/tests/role-management/reports/permission-management-test-report.md` |
| 整体验证测试报告 | 文档 | `/tests/role-management/reports/integration-test-report.md` |
| 问题修复报告 | 文档 | `/tests/role-management/reports/issue-fix-report.md` |

## 8. 风险评估与应对策略

### 8.1 风险 1: 测试数据与实际数据冲突

**应对策略**：
- 使用独立的测试环境进行测试
- 测试数据使用独特的前缀或标识，便于区分
- 测试完成后及时清理测试数据

### 8.2 风险 2: 测试用例覆盖不全面

**应对策略**：
- 基于需求文档和用户场景设计测试用例
- 邀请开发人员和产品经理评审测试用例
- 补充边界情况和异常场景的测试用例

### 8.3 风险 3: 测试环境不稳定

**应对策略**：
- 使用稳定的测试环境
- 定期备份测试数据
- 测试前检查环境状态

### 8.4 风险 4: 发现的问题无法及时修复

**应对策略**：
- 优先级排序：将问题按照优先级分类
- 及时沟通：与开发团队保持密切沟通
- 灵活调整：根据问题修复情况调整测试计划

## 9. 后续维护计划

- 定期更新测试数据，适应系统变化
- 补充新功能的测试用例
- 定期运行集成测试，确保系统稳定性
- 维护测试脚本，确保其有效性

## 10. 沟通计划

- 每日站会：同步测试进展和问题
- 每周评审：评估测试结果和调整计划
- 遇到问题及时沟通：确保问题得到快速解决
- 测试完成后提交测试报告：向 stakeholders 汇报测试结果

## 11. 验收标准

- 所有测试用例通过
- 测试数据准备完成
- 测试报告完整准确
- 发现的问题已修复
- 系统功能正常工作

## 12. 测试执行流程

1. **准备测试环境**：确保测试环境正常运行
2. **插入测试数据**：使用测试数据脚本或 Seed 脚本插入测试数据
3. **执行基础功能测试**：按照测试用例执行基础功能测试
4. **执行权限管理测试**：按照测试用例执行权限管理测试
5. **记录测试结果**：记录测试过程和结果
6. **修复发现的问题**：开发团队修复测试中发现的问题
7. **重新测试**：对修复后的功能进行重新测试
8. **执行整体验证测试**：执行完整的功能流程测试
9. **清理测试数据**：使用清理脚本删除测试数据
10. **生成测试报告**：生成完整的测试报告

## 13. 测试工具配置

### 13.1 Cypress 配置

- 配置文件：`/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/cypress.config.ts`
- 基础 URL：`http://localhost:6767`
- 测试文件路径：`/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/e2e/`

### 13.2 API 测试配置

- 基础 URL：`http://localhost:3030`
- 认证方式：JWT Token
- 测试文件路径：`/Users/staff/Documents/my-tools/vue3-mono/tests/role-management/api/`

## 14. 测试数据管理

- 测试数据版本控制：使用 Git 管理测试数据脚本
- 测试数据备份：定期备份测试数据
- 测试数据清理：测试完成后及时清理测试数据
- 测试数据隔离：确保测试数据与生产数据隔离

## 15. 问题管理

- 问题跟踪工具：使用 Jira 或其他问题跟踪工具
- 问题分类：按照功能模块、严重程度分类
- 问题优先级：高、中、低
- 问题修复流程：发现问题 → 记录问题 → 分配开发人员 → 修复问题 → 验证修复 → 关闭问题

## 16. 质量保证

- 测试用例评审：邀请开发人员和产品经理评审测试用例
- 测试过程评审：定期评审测试过程和结果
- 测试报告评审：测试完成后评审测试报告
- 代码审查：对修复的代码进行审查

## 17. 结论

本计划详细描述了角色管理模块的测试数据准备和集成测试实施计划，包括测试范围、测试用例、实施时间线、资源需求、成功标准等。通过本计划的实施，可以确保角色管理模块的所有功能正常工作，前后端集成正常，为系统上线提供保障。